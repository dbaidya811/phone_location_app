{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">Share Your Live Location</h4>
<p>This page will ask for GPS permission and send your location to the requester in real-time.</p>
<div class="alert alert-info">Keep this page open to continue sharing.</div>
<button id="startBtn" class="btn btn-success mb-3">Start sharing location</button>
<pre id="status" class="p-3 bg-light border rounded">Tap "Start sharing location" to continue…</pre>
<script type="text/javascript">
(function(){
  'use strict';
  const SHARE_TOKEN = "{{ token|e }}";
  const endpoint = '/api/loc/' + SHARE_TOKEN;
  const statusEl = document.getElementById('status');
  const startBtn = document.getElementById('startBtn');

  function postLocation(lat, lng){
    fetch(endpoint, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({lat: lat, lng: lng})
    })
    .then(function(r){ return r.json(); })
    .then(function(d){
      if(!d.ok){ throw new Error('Server rejected'); }
    })
    .catch(function(err){
      console.error(err);
    });
  }

  function isSecureOrigin(){
    if (location.protocol === 'https:') return true;
    const h = location.hostname;
    return h === 'localhost' || h === '127.0.0.1';
  }

  function startSharing(){
    if(!('geolocation' in navigator)){
      statusEl.textContent = 'Geolocation is not supported on this device.';
      return;
    }
    if(!isSecureOrigin()){
      statusEl.textContent = 'Geolocation requires HTTPS. Open this link over https (or use localhost).';
      return;
    }
    statusEl.textContent = 'Requesting permission…';
    var opts = { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 };

    // Trigger permission prompt with a single read first (improves UX on iOS)
    navigator.geolocation.getCurrentPosition(function(){
      statusEl.textContent = 'Permission granted. Starting live updates…';
      navigator.geolocation.watchPosition(function(pos){
          var latitude = pos.coords.latitude;
          var longitude = pos.coords.longitude;
          var accuracy = pos.coords.accuracy;
          statusEl.textContent = 'Sending: ' + latitude.toFixed(6) + ', ' + longitude.toFixed(6) + ' (±' + Math.round(accuracy) + 'm)';
          postLocation(latitude, longitude);
        }, function(err){
          statusEl.textContent = 'Location error: ' + err.message;
        }, opts);
    }, function(err){
      statusEl.textContent = 'Location permission denied or unavailable: ' + err.message;
    }, opts);
  }

  startBtn.addEventListener('click', startSharing, { once: true });
})();
</script>
{% endblock %}
